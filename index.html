<!doctype html>
      <html>
      <head><meta charset="utf-8"><title>Web Worker + file api zim reader</title></head>
      <body>
          <h1>Prototype to test libzim compiled with emscripten</h1>
        Web Worker + file api (only works if file < 2GB <a href="https://github.com/kripken/emscripten/issues/5250"> see emscripten issue </a>)<br/>
        See result in JS console and/or in the iframe below<br/>
        For now, split ZIM files are not supported.<br/>
        If you want to do a quick test, you can choose the file <a href="https://download.kiwix.org/zim/wikipedia/wikipedia_en_ray_charles_maxi_2021-10.zim">wikipedia_en_ray_charles_maxi_2021-10.zim</a>, and use "A/Baby_Grand" as the URL.
        <br/>
        <br/>
        ZIM file(s) : <input type="file" id="your-files" multiple>
      <br/>
      <script>
        var worker = new Worker("a.out.js");
        var control = document.getElementById("your-files");
        control.addEventListener("change", function(event) {
            // When the control has changed, there are new files
            files = control.files;
            console.log("new files selected");
            var tmpMessageChannel = new MessageChannel();
            tmpMessageChannel.port1.onmessage = function(event2){
                console.log(event2.data);
            };
            worker.postMessage({action: "init", files: files}, [tmpMessageChannel.port2]);
            },false);
        function callGetArticleCount() {
            var tmpMessageChannel = new MessageChannel();
            var t0 = performance.now();
            tmpMessageChannel.port1.onmessage = function(event2){
                var t1 = performance.now();
                var readTime = Math.round(t1 - t0);
                document.getElementById("status").textContent = "The ZIM file has " + event2.data + " articles";
                console.log("article count given by the webworker in " + readTime + " milliseconds", event2.data);
            };
            document.getElementById("status").textContent = "Reading articleCount...";
            worker.postMessage({action: "getArticleCount"}, [tmpMessageChannel.port2]);
        }

        function callGetContentByUrl() {
            var tmpMessageChannel = new MessageChannel();
            var url = document.getElementById("url").value;
            var t0 = performance.now();
            tmpMessageChannel.port1.onmessage = function(event2){
                var t1 = performance.now();
                var readTime = Math.round(t1 - t0);
                document.getElementById("status").textContent = "Content read in " + readTime + " milliseconds";
                console.log("Content given by the webworker in " + readTime + " milliseconds", event2.data);
                mimetype = event2.data.mimetype;
                content = event2.data.content;
                if (mimetype && mimetype.startsWith('image')){
                    // It's an image : let's create an image tag in the iframe to display it
                    window.frames[0].document.body.innerHTML = "";
                    var node = document.createElement("img");
                    console.log("image content length " + content.length);
                    var blob = new Blob([content], {
                        type: "image"
                    });
                    var url = URL.createObjectURL(blob);
                    node.addEventListener('load', function () {
                        URL.revokeObjectURL(url);
                    });
                    node.setAttribute("src", url);
                    window.frames[0].document.body.appendChild(node);
                }
                else {
                    // Let's display the content directly in the iframe
                    // TODO : TextDecoder is not supported by all platforms, see https://caniuse.com/?search=textdecoder
                    window.frames[0].document.body.innerHTML = new TextDecoder().decode(content);
                }
            };
            document.getElementById("status").textContent = "Reading content for url " + url;
            worker.postMessage({action: "getContentByUrl", url: url}, [tmpMessageChannel.port2]);
        }
      </script>
      <button type="button" onclick="callGetArticleCount()">Read article count</button>
      <br/>
      URL : <input type="text" id="url" value="A/Baby_Grand"> (you can use I/Baby_Grand_Billy_Joel.jpg.webp to test an image)
      <br/>
      <button type="button" onclick="callGetContentByUrl()">Read content by its URL and display it</button>
      <br/>
      <div id="status"></div>
      <br/>
      <iframe id="iframeResult" style="width:100%; height:400px">
      </iframe>
      </body>
      </html>

